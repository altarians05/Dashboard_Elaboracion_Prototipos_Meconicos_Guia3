<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Maker - Elaboración de Prototipos Mecánicos</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Paleta SENA Institucional */
            --sena-green: #39A900; 
            --sena-blue: #00324D; 
            --sena-orange: #FF6C00;
            --bg-body: #F4F6F9; 
            --bg-card: #FFFFFF; 
            --text-gray: #59667a;
            --shadow: 0 4px 20px rgba(0,0,0,0.08); 
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--sena-blue); line-height: 1.6; overflow-x: hidden; }

        /* HEADER & BRANDING */
        header { 
            background-color: var(--bg-card); 
            padding: 0.8rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 15px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }
        .brand-area { display: flex; align-items: center; gap: 20px; }
        .brand-logos img { height: 55px; width: auto; }
        .program-info h1 { font-family: 'Montserrat', sans-serif; font-size: 1.1rem; color: var(--sena-blue); text-transform: uppercase; letter-spacing: -0.5px; }
        .program-info span { font-size: 0.85rem; color: var(--sena-green); font-weight: 700; }

        /* CONTROLS */
        .data-controls { display: flex; gap: 10px; align-items: center; }
        .btn-data { background: #f0f2f5; border: none; padding: 10px 18px; border-radius: 25px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; color: var(--sena-blue); font-weight: 500; transition: all 0.2s; }
        .btn-data:hover { background: var(--sena-blue); color: white; transform: translateY(-2px); }
        .btn-save { border: 1px solid var(--sena-green); color: var(--sena-green); background: white; }
        .btn-logout { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        #fileInput { display: none; }

        /* GAMIFICATION & PROGRESS */
        .gamification-bar { background: #fff; padding: 15px 2rem; border-bottom: 1px solid #e0e0e0; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .progress-wrapper { width: 100%; max-width: 800px; display: flex; align-items: center; gap: 15px; }
        .progress-container { flex: 1; background: #e9ecef; height: 14px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--sena-green), #86efac, var(--sena-orange)); transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .level-badge { background: var(--sena-orange); color: white; padding: 4px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; box-shadow: 0 4px 10px rgba(255,108,0,0.3); }
        
        #completionMessage { display: none; color: var(--sena-green); font-weight: bold; font-family: 'Montserrat'; animation: pulse 2s infinite; font-size: 1.1rem; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        /* INSIGNIAS SECTION */
        .insignia-container { display: flex; justify-content: center; gap: 25px; padding: 20px; background: #fdfdfd; flex-wrap: wrap; }
        .insignia-item { text-align: center; width: 100px; transition: transform 0.3s ease; filter: grayscale(1) opacity(0.3); position: relative; }
        .insignia-item.earned { filter: grayscale(0) opacity(1); }
        .insignia-item:hover { transform: scale(1.2) translateY(-5px); z-index: 10; }
        .insignia-item img { width: 80px; height: 80px; object-fit: contain; cursor: help; }
        .insignia-name { display: none; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: var(--sena-blue); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 5px; white-space: nowrap; }
        .insignia-item:hover .insignia-name { display: block; }

        /* BIENVENIDA */
        .welcome-section { 
            max-width: 1000px; 
            margin: 3rem auto; 
            display: flex; 
            align-items: center; 
            gap: 40px; 
            background-color: white; /* Color base */
            background-image: url('imagenes/Fondos/Titulos_Mesa de trabajo 1 copia.png'); /* Ruta solicitada */
            background-size: cover;
            background-position: center;
            padding: 2.5rem; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
            position: relative; /* Necesario para el pseudo-elemento */
            z-index: 1;
            overflow: hidden; /* Mantiene el pseudo-elemento dentro de los bordes redondeados */
        }

	/* Capa de opacidad para el fondo de bienvenida */
        .welcome-section::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); /* Controla la opacidad aquí (0.85 es 85% blanco) */
            z-index: -1;
        }

        .welcome-text { flex: 2; text-align: justify; }
        .welcome-text h2 { font-family: 'Montserrat'; color: var(--sena-blue); margin-bottom: 1rem; font-size: 1.8rem; }
        .welcome-text p { font-size: 0.95rem; color: var(--text-gray); margin-bottom: 1rem; }
        .avatar-maker { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 5px solid white; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }

        /* DASHBOARD GRID */
        .container { max-width: 1200px; margin: 0 auto 4rem; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        
        .module-card { 
            background: var(--bg-card); 
            border-radius: var(--radius); 
            padding: 2.5rem; 
            box-shadow: var(--shadow); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer; 
            position: relative; 
            min-height: 280px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        /* Capa de opacidad para fondos de tarjeta */
        .module-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.88); /* Contraste para legibilidad */
            z-index: -1;
            transition: background 0.3s;
        }

        .module-card:hover { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0,0,0,0.12); }
        .module-card:hover::before { background: rgba(255, 255, 255, 0.8); }

        .module-card.locked { opacity: 0.8; pointer-events: none; }
        .module-card.locked::after {
            content: "\f023";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: rgba(0,50,77,0.1);
        }

        .card-number-bg { position: absolute; top: -10px; right: 10px; font-size: 5rem; font-weight: 900; color: rgba(0,0,0,0.10); font-family: 'Montserrat'; z-index: 0; }
        .card-icon { font-size: 1.8rem; color: var(--sena-green); margin-bottom: 1.2rem; background: white; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .card-content h3 { font-family: 'Montserrat'; font-size: 1.1rem; margin-bottom: 0.8rem; color: var(--sena-blue); }
        .card-content p { font-size: 0.85rem; color: var(--text-gray); }

        .status-indicator { font-size: 0.8rem; font-weight: 700; margin-top: 1.5rem; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-indicator.completed { color: var(--sena-green); }
        .status-indicator.active { color: var(--sena-orange); }
        .status-indicator.locked { color: #cbd5e0; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 50, 77, 0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(8px); }
        .modal-box { background: white; padding: 3.5rem; border-radius: 24px; width: 90%; max-width: 480px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
        .modal-input { width: 100%; padding: 15px; margin-bottom: 18px; border: 2px solid #edf2f7; border-radius: 12px; outline: none; transition: border 0.3s; }
        .modal-input:focus { border-color: var(--sena-green); }
        .modal-btn { background: var(--sena-green); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1rem; transition: background 0.3s; }
        .modal-btn:hover { background: #2d8600; }

        footer { text-align: center; padding: 2rem; color: var(--text-gray); font-size: 0.8rem; border-top: 1px solid #e2e8f0; }

        @media (max-width: 768px) {
            .welcome-section { flex-direction: column; text-align: center; margin: 1rem; }
            header { flex-direction: column; gap: 15px; }
        }

/* --- ESTILOS DE LA ANIMACIÓN FINAL (Fuegos Artificiales) --- */
        .finale-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: none; /* Oculto por defecto */
            justify-content: center; align-items: center;
            overflow: hidden;
        }
        .finale-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; pointer-events: none;
        }
        .finale-content {
            position: relative; z-index: 10001; text-align: center;
            animation: zoomInReward 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding: 20px;
        }
        .finale-title {
            font-family: 'Montserrat', sans-serif; font-size: 3rem;
            color: #fff; margin-bottom: 10px; text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255, 108, 0, 0.8);
            line-height: 1.2;
        }
        .finale-subtitle {
            font-size: 1.5rem; color: #a0aec0; margin-bottom: 30px;
        }
        .btn-finish-anim {
            background: var(--sena-orange); color: white; border: none;
            padding: 15px 40px; border-radius: 50px; font-size: 1.2rem;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 108, 0, 0.5);
            transition: transform 0.2s;
        }
        .btn-finish-anim:hover {
            transform: scale(1.1); background: white; color: var(--sena-orange);
        }
        @keyframes zoomInReward {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @media (max-width: 768px) {
            .finale-title { font-size: 2rem; }
        }

    </style>
</head>
<body>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-box">
            <img src="imagenes/Logos/sena.png" alt="SENA" style="height: 70px; margin-bottom: 1.5rem;">
            <h2 style="font-family: 'Montserrat'; color: var(--sena-blue);">Identificación Maker</h2>
            <p style="margin-bottom: 25px; color: var(--text-gray);">Bienvenido Arquitecto de Prototipos. Ingresa tus credenciales para acceder al taller.</p>
            <input type="text" id="studentName" class="modal-input" placeholder="Nombre del Aprendiz">
            <input type="text" id="studentId" class="modal-input" placeholder="Documento de Identidad">
            <button class="modal-btn" onclick="app.login()">ACTIVAR SISTEMAS</button>
        </div>
    </div>

    <header>
        <div class="brand-area">
            <div class="brand-logos"><img src="imagenes/Logos/sena.png" alt="SENA"></div>
            <div class="program-info">
                <h1>Elaboración y Construcción de Prototipos Mecánicos</h1>
                <span>CÓDIGO: 22520106 | TECNOACADEMIA MANIZALES</span>
            </div>
        </div>
        <div class="data-controls">
            <button class="btn-data btn-save" onclick="app.downloadProgress()"><i class="fas fa-cloud-download-alt"></i> Bitácora</button>
            <button class="btn-data" onclick="document.getElementById('fileInput').click()"><i class="fas fa-cloud-upload-alt"></i> Recuperar</button>
            <button class="btn-data btn-logout" onclick="app.logout()"><i class="fas fa-power-off"></i></button>
            <input type="file" id="fileInput" accept=".json" onchange="app.uploadProgress(event)">
            <div style="margin-left:15px; text-align:right;">
                <span id="displayUserName" style="font-weight:bold; font-size:0.95rem; color: var(--sena-blue); display:block;">Cargando...</span>
                <span id="displayUserId" style="font-size:0.75rem; color:var(--sena-green); display:block;">ID: ---</span>
            </div>
            <img src="imagenes/Logos/tecnoacademia.jpeg" alt="TecnoAcademia" style="height:50px; margin-left:15px; border-radius: 8px;">
        </div>
    </header>

    <div class="gamification-bar">
        <div class="progress-wrapper">
            <span style="font-weight: bold; font-size: 0.9rem;">MISIÓN:</span>
            <div class="progress-container">
                <div class="progress-fill" id="globalProgress"></div>
            </div>
            <div class="level-badge" id="levelBadge">Recluta</div>
        </div>
        <div id="completionMessage">✨ ¡FELICITACIONES MAKER! GUÍA COMPLETADA CON ÉXITO ✨</div>
    </div>

    <div class="insignia-container">
        <div class="insignia-item" id="badge-0">
            <img src="imagenes/Insignias/insignias Mohs/00 - Insignias MOHS-Bronce.png" alt="Insignia Bronce">
            <span class="insignia-name">Insignia Bronce (Novato)</span>
        </div>
        <div class="insignia-item" id="badge-1">
            <img src="imagenes/Insignias/insignias Mohs/01 - Insignias MOHS-Plata.png" alt="Insignia Plata">
            <span class="insignia-name">Insignia Plata (Técnico)</span>
        </div>
        <div class="insignia-item" id="badge-2">
            <img src="imagenes/Insignias/insignias Mohs/02 - Insignias MOHS-Oro.png" alt="Insignia Oro">
            <span class="insignia-name">Insignia Oro (Experto)</span>
        </div>
        <div class="insignia-item" id="badge-3">
            <img src="imagenes/Insignias/insignias Mohs/03 - Insignias MOHS-Esmeralda.png" alt="Insignia Esmeralda">
            <span class="insignia-name">Insignia Esmeralda (Maestro)</span>
        </div>
        <div class="insignia-item" id="badge-4">
            <img src="imagenes/Insignias/insignias Mohs/04 - Insignias MOHS-Rubí.png" alt="Insignia Rubí">
            <span class="insignia-name">Insignia Rubí (Guardián Legendario)</span>
        </div>
    </div>

    <div class="container" id="app">
        
        <div class="welcome-section">
            <div class="welcome-text">
                <h2>¡Bienvenido al Centro de Comando Maker!</h2>
                <p>El prototipo físico es una versión preliminar y funcional de un producto, creado para evaluar y probar su diseño, funcionalidad y rendimiento. Con la elaboración de estos prototipos se puede tener un mayor acercamiento a la elaboración de sistemas mecánicos, eléctricos, civiles, entre otros.</p>
                <p>Antes de desarrollar cualquier tipo de prototipo es necesario los planos técnicos que nos indican como podemos dar la construcción de estos prototipos. Por eso cuando se decide validar un prototipo es necesario comparar con el diseño previo realizado (dibujo técnico de los elementos del prototipo).</p>
                <p><strong>Desbloquea todas las insignias y alcanza el rango de Guardián Legendario de la Academia Makers.</strong></p>
            </div>
            <img src="imagenes/Personajes/Maker/Nica.png" class="avatar-maker" alt="Facilitador Maker">
        </div>

        <div class="dashboard-grid">
            
            <div class="module-card" id="card-0" onclick="app.openModule(0)" style="background-image: url('imagenes/Fondos/academia_Makers_exterior_1.png');">
                <div class="card-number-bg">00</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-id-card"></i></div>
                    <h3>IDENTIFICACIÓN DE LA GUÍA</h3>
                    <p>Conoce los objetivos de aprendizaje, los resultados esperados y el mapa de ruta de tu formación mecánica.</p>
                </div>
                <div class="status-indicator" id="status-0"><i class="fas fa-lock"></i> Bloqueado</div>
            </div>

            <div class="module-card" id="card-1" onclick="app.openModule(1)" style="background-image: url('imagenes/Fondos/Bosque_1.png');">
                <div class="card-number-bg">01</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-gamepad"></i></div>
                    <h3>NARRATIVA GAMIFICADA</h3>
                    <p>Sumérgete en la historia de los Guardianes Maker y descubre cómo tus habilidades salvarán el mañana.</p>
                </div>
                <div class="status-indicator" id="status-1"><i class="fas fa-lock"></i> Bloqueado</div>
            </div>

            <div class="module-card" id="card-2" onclick="app.openModule(2)" style="background-image: url('imagenes/Fondos/Fondo_futurista.png');">
                <div class="card-number-bg">02</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-shield-heart"></i></div>
                    <h3>PROTOCOLOS DE SEGURIDAD</h3>
                    <p>Domina las normas de bioseguridad y el uso correcto de EPP en el ambiente de prototipado.</p>
                </div>
                <div class="status-indicator" id="status-2"><i class="fas fa-lock"></i> Bloqueado</div>
            </div>

            <div class="module-card" id="card-3" onclick="app.openModule(3)" style="background-image: url('imagenes/Fondos/Fondo_ingenieria.png');">
                <div class="card-number-bg">03</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-brain"></i></div>
                    <h3>REFLEXIÓN INICIAL</h3>
                    <p>Identifica retos de tu entorno y analiza cómo la mecánica puede transformar realidades sociales.</p>
                </div>
                <div class="status-indicator" id="status-3"><i class="fas fa-lock"></i> Bloqueado</div>
            </div>

            <div class="module-card" id="card-4" onclick="app.openModule(4)" style="background-image: url('imagenes/Fondos/Fondo_laboratorio.png');">
                <div class="card-number-bg">04</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-map-location-dot"></i></div>
                    <h3>CONTEXTUALIZACIÓN</h3>
                    <p>Explora las bases del diseño mecánico y los principios físicos que rigen los prototipos modernos.</p>
                </div>
                <div class="status-indicator" id="status-4"><i class="fas fa-lock"></i> Bloqueado</div>
            </div>

            <div class="module-card" id="card-5" onclick="app.openModule(5)" style="background-image: url('imagenes/Fondos/salón_1.png');">
                <div class="card-number-bg">05</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-microchip"></i></div>
                    <h3>APROPIACIÓN</h3>
                    <p>Aprende técnicas de dibujo técnico, selección de materiales y tecnologías de fabricación avanzada.</p>
                </div>
                <div class="status-indicator" id="status-5"><i class="fas fa-lock"></i> Bloqueado</div>
            </div>

            <div class="module-card" id="card-6" onclick="app.openModule(6)" style="background-image: url('imagenes/Fondos/aula tecnologica.png');">
                <div class="card-number-bg">06</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-hammer"></i></div>
                    <h3>TRANSFERENCIA</h3>
                    <p>¡Manos a la obra! Construye y valida tu prototipo mecánico aplicando todo lo aprendido.</p>
                </div>
                <div class="status-indicator" id="status-6"><i class="fas fa-lock"></i> Bloqueado</div>
            </div>

            <div class="module-card" id="card-7" onclick="app.openModule(7)" style="background-image: url('imagenes/Fondos/salon de quimica.png');">
    <div class="card-number-bg">07</div>
    <div class="card-content">
        <div class="card-icon"><i class="fas fa-file-contract"></i></div>
        <h3>EVIDENCIAS DE APRENDIZAJE</h3>
        <p>Organiza tu portafolio de evidencias y sustenta el funcionamiento técnico de tu creación.</p>
    </div>
    <div class="status-indicator" id="status-7"><i class="fas fa-play-circle"></i> Disponible</div>
</div>

            <div class="module-card" id="card-8" onclick="app.openModule(8)" style="background-image: url('imagenes/Fondos/Fondo_ingenieria.png'); border-top: 5px solid var(--sena-blue);">
                <div class="card-number-bg">08</div>
                <div class="card-content">
                    <div class="card-icon"><i class="fas fa-book"></i></div>
                    <h3>GLOSARIO TÉCNICO</h3>
                    <p>Diccionario especializado de ingeniería, mecánica y cultura Maker para tu consulta permanente.</p>
                </div>
                <div class="status-indicator" id="status-8"><i class="fas fa-book-open"></i> Consulta</div>
            </div>

        </div>
    </div>

<div id="finaleOverlay" class="finale-overlay">
        <canvas id="fireworksCanvas" class="finale-canvas"></canvas>
        <div class="finale-content">
            <h1 class="finale-title">¡FELICITACIONES<br>GUARDIÁN LEGENDARIO!</h1>
            <p class="finale-subtitle">Has completado todos los módulos y dominado la ingeniería maker.</p>
            <button class="btn-finish-anim" onclick="app.closeFinale()">CONTINUAR AL DASHBOARD</button>
        </div>
    </div>

    <footer>
        <p>© 2026 TecnoAcademia Manizales - Línea de Ingeniería y Diseño</p>
        <p>Servicio Nacional de Aprendizaje SENA</p>
    </footer>

<script>
        const app = {
            storageKey: 'makerCourseState',
            state: { 
                studentName: "", 
                studentId: "", 
                unlockedModules: [0, 7, 8], 
                completedModules: [] 
            },
            fireworksInterval: null, // Variable para controlar la animación

            init: function() {
                const savedState = localStorage.getItem(this.storageKey);
                if (savedState) { 
                    this.state = JSON.parse(savedState); 
                    this.updateUI(); 
                    document.getElementById('loginModal').style.display = 'none'; 
                }
                else { 
                    document.getElementById('loginModal').style.display = 'flex'; 
                }
            },
            
            login: function() {
                const name = document.getElementById('studentName').value.trim();
                const id = document.getElementById('studentId').value.trim();
                if(!name || !id) return alert("¡Atención Maker! Debes ingresar tu nombre e ID.");
                
                this.state.studentName = name; 
                this.state.studentId = id;
                this.saveLocal(); 
                this.updateUI();
                document.getElementById('loginModal').style.display = 'none';
            },
            
            logout: function() {
                if(confirm("¿Deseas cerrar el Centro de Comando? Asegúrate de haber descargado tu bitácora de progreso.")) { 
                    localStorage.removeItem(this.storageKey); 
                    location.reload(); 
                }
            },
            
            saveLocal: function() { 
                localStorage.setItem(this.storageKey, JSON.stringify(this.state)); 
            },
            
            updateUI: function() {
                document.getElementById('displayUserName').textContent = this.state.studentName;
                document.getElementById('displayUserId').textContent = "ID: " + this.state.studentId;
                
                const totalModules = 9; 
                // Filtramos para asegurar que cuenta solo módulos validos (0-8)
                const completedCount = this.state.completedModules.filter(m => m >= 0 && m <= 8).length;
                
                // Evitar más del 100% si hubiera errores en datos
                const percent = Math.min(100, Math.round((completedCount / totalModules) * 100));
                
                document.getElementById('globalProgress').style.width = percent + '%';
                
                // Actualizar Niveles
                let lvl = "Recluta Maker";
                if(percent >= 20) lvl = "Explorador de Sistemas";
                if(percent >= 40) lvl = "Cadete de Diseño";
                if(percent >= 60) lvl = "Técnico Mecánico";
                if(percent >= 80) lvl = "Ingeniero Maker";
                
                // --- CAMBIO AQUÍ: LÓGICA DE FINALIZACIÓN ---
                if(percent === 100) {
                    lvl = "Guardián Legendario";
                    document.getElementById('completionMessage').style.display = 'block';
                    
                    // Verificamos si ya mostramos la animación en esta sesión para no ser molestos
                    if (!sessionStorage.getItem('finaleShown')) {
                        this.triggerFinale();
                        sessionStorage.setItem('finaleShown', 'true');
                    }
                }
                document.getElementById('levelBadge').textContent = lvl;

                // Actualizar Tarjetas
                for(let i=0; i<=8; i++) {
                    const card = document.getElementById(`card-${i}`);
                    const status = document.getElementById(`status-${i}`);
                    if(!card) continue;

                    card.classList.remove('locked');
                    if(this.state.completedModules.includes(i)) {
                        status.className = 'status-indicator completed';
                        status.innerHTML = '<i class="fas fa-check-circle"></i> Misión Cumplida';
                    } else if(this.state.unlockedModules.includes(i)) {
                        status.className = 'status-indicator active';
                        status.innerHTML = '<i class="fas fa-play-circle"></i> En Curso';
                    } else {
                        card.classList.add('locked');
                        status.className = 'status-indicator locked';
                        status.innerHTML = '<i class="fas fa-lock"></i> Acceso Restringido';
                    }
                }

                this.updateBadges();
            },

            updateBadges: function() {
                // Definimos qué módulo completa cada medalla (index de la medalla : id del módulo)
                // 0: Bronce (Módulo 2)
                // 1: Plata (Módulo 3)
                // 2: Oro (Módulo 4)
                // 3: Esmeralda (Módulo 5)
                // 4: Rubí (Módulo 6)
                const badgeRequirements = {
                    0: 2, 
                    1: 3, 
                    2: 4, 
                    3: 5, 
                    4: 6
                };

                // Recorremos las 5 medallas (0 a 4)
                for (let i = 0; i < 5; i++) {
                    const badgeElement = document.getElementById(`badge-${i}`);
                    if (!badgeElement) continue;

                    const requiredModule = badgeRequirements[i];
                    
                    // Verificamos si el ID del módulo requerido está en el array de completados
                    if (this.state.completedModules.includes(requiredModule)) {
                        badgeElement.classList.add('earned');
                    } else {
                        badgeElement.classList.remove('earned');
                    }
                }
            },
            
            openModule: function(id) {
                if(!this.state.unlockedModules.includes(id)) {
                    return alert("⚠️ SISTEMA BLOQUEADO: Debes completar el módulo anterior para desbloquear esta zona.");
                }
                window.location.href = `modulo${id}.html`;
            },

            downloadProgress: function() {
                const dataStr = JSON.stringify(this.state, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Bitacora_Maker_${this.state.studentId}.json`;
                a.click();
            },

            uploadProgress: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loaded = JSON.parse(e.target.result);
                        if(loaded.studentId) {
                            this.state = loaded;
                            this.saveLocal();
                            this.updateUI();
                            alert("¡Sistemas Sincronizados! Progreso cargado correctamente.");
                        }
                    } catch(err) { alert("Archivo de bitácora no reconocido."); }
                };
                reader.readAsText(file);
            },

            // --- NUEVAS FUNCIONES PARA LA ANIMACIÓN FINAL ---
            
            triggerFinale: function() {
                const overlay = document.getElementById('finaleOverlay');
                overlay.style.display = 'flex'; // Mostrar overlay
                this.startFireworks(); // Iniciar pirotecnia
            },

            closeFinale: function() {
                const overlay = document.getElementById('finaleOverlay');
                overlay.style.display = 'none';
                // Detener la animación para ahorrar memoria
                if (this.fireworksInterval) clearInterval(this.fireworksInterval);
            },

            startFireworks: function() {
                const canvas = document.getElementById('fireworksCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const particles = [];
                
                function Particle(x, y, color) {
                    this.x = x;
                    this.y = y;
                    this.color = color;
                    this.velocity = {
                        x: (Math.random() - 0.5) * 8,
                        y: (Math.random() - 0.5) * 8
                    };
                    this.alpha = 1;
                    this.friction = 0.96;
                }

                Particle.prototype.draw = function() {
                    ctx.save();
                    ctx.globalAlpha = this.alpha;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 3, 0, Math.PI * 2, false);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    ctx.restore();
                };

                Particle.prototype.update = function() {
                    this.velocity.x *= this.friction;
                    this.velocity.y *= this.friction;
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
                    this.alpha -= 0.01;
                };

                const colors = ['#FF6C00', '#39A900', '#00324D', '#FFD700', '#FF0055', '#00FFFF'];

                function createFirework(x, y) {
                    const particleCount = 80;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    for (let i = 0; i < particleCount; i++) {
                        particles.push(new Particle(x, y, color));
                    }
                }

                function animate() {
                    requestAnimationFrame(animate);
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; // Efecto de rastro
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    particles.forEach((particle, index) => {
                        if (particle.alpha > 0) {
                            particle.update();
                            particle.draw();
                        } else {
                            particles.splice(index, 1);
                        }
                    });
                }

                animate();

                // Lanzar cohetes automáticamente
                this.fireworksInterval = setInterval(() => {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * (canvas.height / 2); // Solo en la mitad superior
                    createFirework(x, y);
                }, 400); // Frecuencia de explosiones

                // Redimensionar si cambia la ventana
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>